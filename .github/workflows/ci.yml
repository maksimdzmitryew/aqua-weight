name: CI

on:
  push:
    branches: [ main, master, develop, '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  backend:
    name: Backend (lint, types, tests, coverage)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          if [ -f backend/requirements-tests.txt ]; then pip install -r backend/requirements-tests.txt; fi
          # Ensure tools available even if not pinned
          pip install pytest pytest-cov ruff black mypy

      - name: Ruff (lint)
        run: ruff check .

      - name: Black (format check)
        run: black --check .

      - name: Mypy (type check)
        run: mypy backend

      - name: Pytest (with coverage)
        run: |
          pytest -q --cov=backend/app --cov-report=xml:backend-coverage.xml --cov-report=term-missing --cov-fail-under=70

      - name: Upload backend coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-xml
          path: backend-coverage.xml

  frontend:
    name: Frontend (lint, format, unit tests, coverage)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Use npm 11.6.2
        run: npm i -g npm@11.6.2

      - name: Disable npm update notifier in CI
        run: echo "NPM_CONFIG_UPDATE_NOTIFIER=false" >> $GITHUB_ENV

      - name: Install dependencies
        working-directory: frontend
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          # Install dev tools on-the-fly if missing in package.json
          npx --yes npm-which eslint >/dev/null 2>&1 || npm i -D eslint eslint-plugin-react
          npx --yes npm-which prettier >/dev/null 2>&1 || npm i -D prettier
          # Jest stack for React + Vite
          npm i -D jest @testing-library/react @testing-library/jest-dom @testing-library/user-event babel-jest @babel/preset-env @babel/preset-react identity-obj-proxy

      - name: Create temporary Babel config for jest
        if: ${{ always() }}
        working-directory: frontend
        run: |
          # Only create if not present in repo; use printf to avoid YAML heredoc pitfalls
          if [ ! \
            -f babel.config.cjs ] && [ ! -f babel.config.js ] && [ ! -f .babelrc ]; then \
            printf "%s\n" \
              "module.exports = {" \
              "  presets: [" \
              "    [require.resolve('@babel/preset-env'), { targets: { node: 'current' } }]," \
              "    require.resolve('@babel/preset-react')," \
              "  ]," \
              "};" > babel.config.cjs; \
          fi

      - name: ESLint
        working-directory: frontend
        run: |
          # Provide a minimal flat config for ESLint v9 if none exists in repo
          if [ ! -f eslint.config.js ] && [ ! -f eslint.config.cjs ] && [ ! -f .eslintrc ] && [ ! -f .eslintrc.js ] && [ ! -f .eslintrc.json ] && [ ! -f .eslintrc.cjs ]; then \
            printf "%s\n" \
              "module.exports = [" \
              "  {" \
              "    files: ['**/*.{js,jsx,ts,tsx}']," \
              "    languageOptions: { ecmaVersion: 'latest', sourceType: 'module' }," \
              "    plugins: { react: require('eslint-plugin-react') }," \
              "    rules: {}" \
              "  }" \
              "];" > eslint.config.cjs; \
          fi
          npx eslint . --config eslint.config.cjs

      - name: Prettier (check)
        working-directory: frontend
        run: npx prettier . --check

      - name: Run unit tests (Jest) with coverage
        working-directory: frontend
        run: |
          # If jest config exists, run; otherwise skip gracefully
          if [ -f jest.config.cjs ] || [ -f jest.config.js ] || [ -f jest.config.ts ]; then
            npx jest --coverage --ci --runInBand --reporters=default --coverageReporters=json-summary,text,lcov,cobertura
          else
            echo "No jest config found; skipping frontend unit tests"
          fi

      - name: Enforce frontend coverage >= 60%
        if: ${{ always() }}
        working-directory: frontend
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            pct=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            pct_int=$(printf '%.0f' "$pct")
            echo "Frontend coverage: ${pct}%"
            if [ "$pct_int" -lt 60 ]; then
              echo "Coverage below threshold (60%)." >&2
              exit 1
            fi
          else
            echo "No coverage summary generated; skipping coverage gate."
          fi

      - name: Upload frontend coverage artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage

  e2e:
    name: E2E (Playwright via docker-compose stack)
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright binaries
        working-directory: frontend
        run: |
          npm i -D @playwright/test
          npx playwright install --with-deps

      - name: Start test stack (docker-compose)
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: Wait for nginx to be ready
        run: |
          for i in {1..60}; do
            if curl -sSf http://localhost:5080/ >/dev/null; then
              echo "nginx is up"; break; fi; echo "Waiting for nginx..."; sleep 5; done
          curl -sSf http://localhost:5080/ >/dev/null

      - name: Run Playwright tests
        working-directory: frontend
        env:
          E2E_BASE_URL: http://localhost:5080
        run: npx playwright test --config ./playwright.config.ts

      - name: Upload Playwright report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report

  pre-commit:
    name: Pre-commit hooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit
      - name: Run pre-commit (if configured)
        run: |
          if [ -f .pre-commit-config.yaml ]; then
            # Use a CI-only trimmed config to avoid initializing JS mirrors (eslint/prettier)
            printf "%s\n" \
              "repos:" \
              "  - repo: https://github.com/pre-commit/pre-commit-hooks" \
              "    rev: v4.6.0" \
              "    hooks:" \
              "      - id: trailing-whitespace" \
              "      - id: end-of-file-fixer" \
              "      - id: check-merge-conflict" \
              "" \
              "  - repo: https://github.com/astral-sh/ruff-pre-commit" \
              "    rev: v0.6.9" \
              "    hooks:" \
              "      - id: ruff" \
              "        args: ['--fix']" \
              "        types_or: [python]" \
              "        files: ^backend/|" \
              "      - id: ruff-format" \
              "        types_or: [python]" \
              "        files: ^backend/|" \
              "" \
              "  - repo: https://github.com/psf/black" \
              "    rev: 24.10.0" \
              "    hooks:" \
              "      - id: black" \
              "        types_or: [python]" \
              "        files: ^backend/|" \
              "" \
              "  - repo: https://github.com/pre-commit/mirrors-mypy" \
              "    rev: v1.11.2" \
              "    hooks:" \
              "      - id: mypy" \
              "        args: ['--config-file=pyproject.toml']" \
              "        files: ^backend/|" \
              > .pre-commit-config.ci.yaml
            pre-commit run --all-files --show-diff-on-failure --color always --config .pre-commit-config.ci.yaml
          else
            echo "No .pre-commit-config.yaml; skipping."
          fi
